<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Logger</title>
    <meta name="theme-color" content="#3498db"/>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="images/icon-192x192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #installBtn {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-2xl">
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <header class="text-center mb-6">
                <h1 class="text-3xl font-bold text-gray-900">GPS Logger</h1>
                <p class="text-gray-500 mt-1">A simple PWA to log your location.</p>
            </header>

            <div id="install-container" class="text-center mb-4">
                 <button id="installBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">
                    Install App
                </button>
            </div>

            <div class="flex flex-col md:flex-row gap-4 mb-6">
                <button id="startBtn" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">
                    Start Logging
                </button>
                <button id="stopBtn" disabled class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 disabled:bg-red-300 disabled:cursor-not-allowed">
                    Stop Logging
                </button>
            </div>

            <div id="status" class="text-center text-gray-600 mb-6 p-4 bg-gray-50 rounded-lg">
                Status: Idle
            </div>

            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                <h2 class="text-xl font-semibold mb-2 text-center">Current Location</h2>
                <div id="currentLocation" class="text-center text-lg text-gray-700">
                    <p>Latitude: <span id="latitude">-</span></p>
                    <p>Longitude: <span id="longitude">-</span></p>
                    <p>Timestamp: <span id="timestamp">-</span></p>
                </div>
            </div>

            <div>
                <h2 class="text-xl font-semibold mb-4 text-center">Logged Data</h2>
                <div class="h-64 overflow-y-auto bg-white border border-gray-200 rounded-lg p-2">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                            <tr>
                                <th scope="col" class="px-6 py-3">Latitude</th>
                                <th scope="col" class="px-6 py-3">Longitude</th>
                                <th scope="col" class="px-6 py-3">Time</th>
                            </tr>
                        </thead>
                        <tbody id="log-table-body">
                           <!-- Logged data will appear here -->
                        </tbody>
                    </table>
                </div>
                 <button id="downloadBtn" class="w-full mt-4 bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 disabled:bg-gray-400" disabled>
                    Download Log (CSV)
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const installBtn = document.getElementById('installBtn');
        const statusDiv = document.getElementById('status');
        const latitudeSpan = document.getElementById('latitude');
        const longitudeSpan = document.getElementById('longitude');
        const timestampSpan = document.getElementById('timestamp');
        const logTableBody = document.getElementById('log-table-body');

        // --- App State ---
        let intervalId = null;
        let loggedCoordinates = [];
        let deferredInstallPrompt = null;
        
        const geoOptions = {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        };

        // --- Geolocation Logic ---

        // Function to request the current position
        const fetchPosition = () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(positionSuccess, positionError, geoOptions);
            }
        };
        
        // Function to start logging every 10 seconds
        const startLogging = () => {
            if (navigator.geolocation) {
                statusDiv.textContent = 'Status: Starting...';
                
                // Fetch the first position immediately, then set an interval to fetch it every 10 seconds.
                fetchPosition();
                intervalId = setInterval(fetchPosition, 10000);

                // Update UI state
                startBtn.disabled = true;
                stopBtn.disabled = false;
                downloadBtn.disabled = true;
                loggedCoordinates = []; // Clear previous log
                logTableBody.innerHTML = ''; // Clear table
            } else {
                statusDiv.textContent = 'Geolocation is not supported by your browser.';
            }
        };

        // Function to stop logging
        const stopLogging = () => {
            if (intervalId !== null) {
                clearInterval(intervalId); // Use clearInterval to stop the interval
                intervalId = null;
                statusDiv.textContent = 'Status: Idle';
                // Update UI state
                startBtn.disabled = false;
                stopBtn.disabled = true;
                if (loggedCoordinates.length > 0) {
                    downloadBtn.disabled = false;
                }
            }
        };

        // Success callback for getCurrentPosition
        const positionSuccess = (position) => {
            const { latitude, longitude } = position.coords;
            const timestamp = new Date(position.timestamp);
            const formattedTime = timestamp.toLocaleTimeString();

            // Update current location display
            latitudeSpan.textContent = latitude.toFixed(6);
            longitudeSpan.textContent = longitude.toFixed(6);
            timestampSpan.textContent = formattedTime;

            // Update status
            statusDiv.textContent = 'Status: Logging...';

            // Store the new coordinate
            const newCoord = { latitude, longitude, timestamp };
            loggedCoordinates.push(newCoord);

            // Add new row to the log table
            const row = logTableBody.insertRow(0); // Insert at the top
            row.className = 'bg-white border-b';
            row.innerHTML = `
                <td class="px-6 py-4">${latitude.toFixed(6)}</td>
                <td class="px-6 py-4">${longitude.toFixed(6)}</td>
                <td class="px-6 py-4">${formattedTime}</td>
            `;
        };

        // Error callback for getCurrentPosition
        const positionError = (error) => {
            let errorMessage = 'An unknown error occurred.';
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = 'User denied the request for Geolocation.';
                    stopLogging(); // Stop logging entirely if permission is denied
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = 'Location information is unavailable. Retrying in 10s...';
                    break;
                case error.TIMEOUT:
                    errorMessage = 'The request to get user location timed out. Retrying in 10s...';
                    break;
            }
            statusDiv.textContent = `Error: ${errorMessage}`;
        };

        // --- Data Download Logic ---

        // Function to download logged data as a CSV file
        const downloadLog = () => {
            if (loggedCoordinates.length === 0) {
                // This alert is a fallback, but a more integrated UI message would be better.
                statusDiv.textContent = 'No data to download.';
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Latitude,Longitude,Timestamp\r\n"; // Header row

            loggedCoordinates.forEach(coord => {
                const row = `${coord.latitude},${coord.longitude},"${coord.timestamp.toISOString()}"`;
                csvContent += row + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `gps_log_${new Date().toISOString()}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // --- PWA Installation Logic ---

        // Listen for the beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (event) => {
            // Prevent the default browser prompt
            event.preventDefault();
            // Stash the event so it can be triggered later.
            deferredInstallPrompt = event;
            // Show the install button
            installBtn.style.display = 'block';
        });

        // Handle install button click
        const installApp = () => {
            if (deferredInstallPrompt) {
                // Show the browser's install prompt
                deferredInstallPrompt.prompt();
                // Wait for the user to respond to the prompt
                deferredInstallPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    } else {
                        console.log('User dismissed the install prompt');
                    }
                    // We can only use the prompt once, so clear it.
                    deferredInstallPrompt = null;
                    // Hide the install button
                    installBtn.style.display = 'none';
                });
            }
        };

        // --- Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }

        // --- Event Listeners ---
        startBtn.addEventListener('click', startLogging);
        stopBtn.addEventListener('click', stopLogging);
        downloadBtn.addEventListener('click', downloadLog);
        installBtn.addEventListener('click', installApp);

    </script>
    
    <!-- This is a placeholder for the manifest.json file. In a real project, this would be a separate file. -->
    <script type="application/json" id="manifest-placeholder">
    {
      "name": "GPS Logger PWA",
      "short_name": "GPSLog",
      "description": "A simple Progressive Web App to log GPS coordinates.",
      "start_url": ".",
      "display": "standalone",
      "background_color": "#ffffff",
      "theme_color": "#3498db",
      "icons": [
        {
          "src": "images/icon-192x192.png",
          "sizes": "192x192",
          "type": "image/png"
        },
        {
          "src": "images/icon-512x512.png",
          "sizes": "512x512",
          "type": "image/png"
        }
      ]
    }
    </script>
    
    <!-- This is a placeholder for the service-worker.js file. In a real project, this would be a separate file. -->
    <script type="application/javascript" id="sw-placeholder">
        const CACHE_NAME = 'gps-logger-cache-v1';
        const urlsToCache = [
            '/',
            '/index.html',
            'https://cdn.tailwindcss.com',
            'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap'
        ];

        self.addEventListener('install', event => {
            event.waitUntil(
                caches.open(CACHE_NAME)
                    .then(cache => {
                        console.log('Opened cache');
                        return cache.addAll(urlsToCache);
                    })
            );
        });

        self.addEventListener('fetch', event => {
            event.respondWith(
                caches.match(event.request)
                    .then(response => {
                        // Cache hit - return response
                        if (response) {
                            return response;
                        }
                        return fetch(event.request);
                    }
                )
            );
        });
        
        self.addEventListener('activate', event => {
          const cacheWhitelist = [CACHE_NAME];
          event.waitUntil(
            caches.keys().then(cacheNames => {
              return Promise.all(
                cacheNames.map(cacheName => {
                  if (cacheWhitelist.indexOf(cacheName) === -1) {
                    return caches.delete(cacheName);
                  }
                })
              );
            })
          );
        });

    </script>
    
    <!-- In a real deployment, you would have separate manifest.json and service-worker.js files.
         For this self-contained example, we'll create them dynamically. -->
    <script>
        // Create a blob URL for the manifest
        const manifestContent = document.getElementById('manifest-placeholder').textContent;
        const manifestBlob = new Blob([manifestContent], {type: 'application/json'});
        const manifestUrl = URL.createObjectURL(manifestBlob);
        document.querySelector('link[rel="manifest"]').setAttribute('href', manifestUrl);

        // Create a blob URL for the service worker
        const swContent = document.getElementById('sw-placeholder').textContent;
        const swBlob = new Blob([swContent], {type: 'application/javascript'});
        const swUrl = URL.createObjectURL(swBlob);
        
        // Overwrite the service worker registration to use the blob URL
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register(swUrl)
                    .then(registration => {
                        console.log('ServiceWorker (from blob) registration successful with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker (from blob) registration failed: ', error);
                    });
            });
        }
        
        // Create dummy image placeholders since we can't link to external/local files
        // In a real app, these would be actual image files.
        function createPlaceholderIcon(size) {
            const canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#3498db';
            ctx.fillRect(0, 0, size, size);
            ctx.fillStyle = 'white';
            ctx.font = `${size/4}px Inter`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('GPS', size/2, size/2);
            return canvas.toDataURL();
        }
        
        const manifestJson = JSON.parse(manifestContent);
        manifestJson.icons.forEach(icon => {
            if (icon.sizes === '192x192') {
                icon.src = createPlaceholderIcon(192);
            }
            if (icon.sizes === '512x512') {
                icon.src = createPlaceholderIcon(512);
            }
        });
        
        const updatedManifestBlob = new Blob([JSON.stringify(manifestJson)], {type: 'application/json'});
        const updatedManifestUrl = URL.createObjectURL(updatedManifestBlob);
        document.querySelector('link[rel="manifest"]').setAttribute('href', updatedManifestUrl);
        document.querySelector('link[rel="apple-touch-icon"]').setAttribute('href', createPlaceholderIcon(192));

    </script>
</body>
</html>
